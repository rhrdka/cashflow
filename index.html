<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cashflow — Dashboard Modern (Mobile-friendly)</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <!-- html2canvas & jsPDF for export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --accent: #5b9df9;
      --bg-dark: #071025;
      --muted: #98a0b3;
      --card-radius: 14px;
    }
    html,body { height:100%; }
    body {
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #071025 0%, #041225 100%);
      color: #e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:84px;
    }
    .container-main { max-width:1100px; margin:20px auto; padding:16px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo { width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,#bfe1ff,#5b9df9); display:flex; align-items:center; justify-content:center; color:#042a5a; font-weight:700; }
    .brand h1 { margin:0; font-size:1rem; color:#f7fbff; }
    .brand small { display:block; color:var(--muted); font-size:.78rem; margin-top:2px; }

    /* grid & cards */
    .grid { display:grid; gap:12px; grid-template-columns: repeat(12, 1fr); }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: var(--card-radius); border:1px solid rgba(255,255,255,0.03); padding:12px; transition: transform .22s, box-shadow .22s; }
    .card:hover { transform: translateY(-6px); box-shadow:0 18px 40px rgba(3,6,23,0.6); }
    .muted-sm { color:var(--muted); font-size:.85rem; }
    .balance { font-weight:700; font-size:1.2rem; color:#fff; }
    .icon-circle { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; }

    /* layout spans */
    .card-1, .card-2, .card-3, .card-4 { grid-column: span 3; }
    @media (max-width: 992px) {
      .card-1, .card-2, .card-3, .card-4 { grid-column: span 6; }
    }
    @media (max-width: 640px) {
      .card-1, .card-2, .card-3, .card-4 { grid-column: span 12; }
      .container-main { padding:10px; margin:10px; }
    }

    /* charts */
    .charts { display:grid; grid-template-columns: 2fr 1fr; gap:12px; margin-top:10px; }
    @media (max-width: 900px) { .charts { grid-template-columns: 1fr; } }

    /* transactions */
    .transactions-card { grid-column: 1 / -1; margin-top:12px; padding:10px; }
    .table thead th { color:var(--muted); font-size:.85rem; }
    .badge-cat { font-size:.78rem; padding:.25rem .45rem; border-radius:10px; background: rgba(255,255,255,0.02); color:var(--muted); }

    /* FAB (floating add button) */
    .fab-wrap {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 1100;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
    }
    .fab-bg {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 84px;
      height: 84px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(91,157,249,0.16), rgba(91,157,249,0.06));
      filter: blur(6px);
      z-index: -1;
    }
    .fab {
      width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,#5b9df9,#2b7be8);
      box-shadow: 0 12px 30px rgba(43,123,232,0.25); color:#fff; border:0;
      display:flex; align-items:center; justify-content:center; font-size:1.4rem;
    }
    .fab:active { transform: translateY(1px) scale(.995); }

    /* improved touch targets on mobile */
    .btn, .form-control, .form-select { min-height:38px; }

    /* custom category input */
    .d-none { display:none !important; }

    /* responsive table for small screens */
    .table-responsive { -webkit-overflow-scrolling: touch; }

    /* modal adjustments */
    .modal-content { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; color:inherit; }
    .form-control, .form-select { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); color:inherit; }

    /* small animations */
    .enter { animation: fadeInUp .36s ease both; }
    @keyframes fadeInUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform:none; } }
  </style>
</head>
<body>
  <div class="container-main">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><i class="bi bi-cash-stack" style="font-size:1.05rem"></i></div>
        <div>
          <h1>Cashflow</h1>
          <small>Ringkas • Mobile-friendly</small>
        </div>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <button id="btnExportPDF" class="btn btn-outline-light btn-sm" title="Export PDF"><i class="bi bi-file-earmark-pdf"></i></button>
        <button id="btnExportCSV" class="btn btn-outline-light btn-sm" title="Export CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
        <button id="btnImportCSV" class="btn btn-outline-light btn-sm" title="Import CSV"><i class="bi bi-file-earmark-arrow-up"></i></button>
        <!-- header add hidden on small (we keep FAB primary) -->
        <button id="btnAddHeader" class="btn btn-primary btn-sm ms-2 d-none d-md-inline" data-bs-toggle="modal" data-bs-target="#modalForm"><i class="bi bi-plus-lg"></i> Tambah</button>
      </div>
    </div>

    <div class="grid">
      <div class="card card-1 enter">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="muted-sm">Saldo</div>
            <div id="cardBalance" class="balance">Rp 0</div>
            <div id="cardNetLabel" class="muted-sm">Total</div>
          </div>
          <div class="icon-circle" style="background:linear-gradient(135deg,#e6f0ff,#cfe9ff);"><i class="bi bi-wallet2" style="color:#052036"></i></div>
        </div>
      </div>

      <div class="card card-2 enter">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="muted-sm">Pemasukan</div>
            <div id="cardIncome" class="balance text-success">Rp 0</div>
            <div class="muted-sm">Total pemasukan</div>
          </div>
          <div class="icon-circle" style="background:linear-gradient(135deg,#e9fbf0,#bff6da)"><i class="bi bi-cash-stack text-success"></i></div>
        </div>
      </div>

      <div class="card card-3 enter">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="muted-sm">Pengeluaran</div>
            <div id="cardExpense" class="balance text-danger">Rp 0</div>
            <div class="muted-sm">Total pengeluaran</div>
          </div>
          <div class="icon-circle" style="background:linear-gradient(135deg,#fff0f0,#ffdede)"><i class="bi bi-credit-card-2-back text-danger"></i></div>
        </div>
      </div>

      <div class="card card-4 enter">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="muted-sm">Transaksi</div>
            <div id="cardCount" class="balance">0</div>
            <div class="muted-sm">Total transaksi</div>
          </div>
          <div class="icon-circle" style="background:linear-gradient(135deg,#faf7ff,#e9deff)"><i class="bi bi-list-check"></i></div>
        </div>
      </div>

      <div class="card chart-card charts enter" style="grid-column: 1 / -1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 style="margin:0">Tren & Komposisi</h6>
            <small class="muted-sm">Tren saldo dan per kategori</small>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <select id="trendRange" class="form-select form-select-sm" style="width:120px">
              <option value="7">7 Hari</option>
              <option value="30" selected>30 Hari</option>
              <option value="90">90 Hari</option>
              <option value="365">1 Tahun</option>
              <option value="all">Semua</option>
            </select>
            <button id="btnRefreshCharts" class="btn btn-outline-light btn-sm" title="Refresh"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:12px; align-items:stretch; flex-wrap:wrap;">
          <div class="card p-2" id="lineChartCard" style="flex:2; min-width:260px; min-height:240px;">
            <canvas id="lineChart" style="max-height:320px"></canvas>
          </div>
          <div class="card p-2" id="pieChartCard" style="flex:1; min-width:200px; min-height:240px;">
            <canvas id="pieChart" style="max-height:320px"></canvas>
          </div>
        </div>
      </div>

      <div class="card transactions-card enter">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-3">
          <div class="d-flex gap-2 align-items-center" style="flex:1; min-width:200px;">
            <div class="input-group input-group-sm" style="max-width:360px;">
              <span class="input-group-text bg-transparent border-0 text-muted"><i class="bi bi-search"></i></span>
              <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="Cari deskripsi atau kategori...">
            </div>

            <select id="filterTime" class="form-select form-select-sm" style="width:150px;">
              <option value="all" selected>Semua</option>
              <option value="today">Hari ini</option>
              <option value="month">Bulan ini</option>
              <option value="year">Tahun ini</option>
              <option value="custom">Rentang...</option>
            </select>

            <div id="customRange" class="d-none d-flex gap-2 align-items-center">
              <input id="customFrom" type="date" class="form-control form-control-sm">
              <input id="customTo" type="date" class="form-control form-control-sm">
              <button id="applyRange" class="btn btn-sm btn-outline-light">Terapkan</button>
            </div>
          </div>

          <div class="d-flex gap-2">
            <button id="btnClearAll" class="btn btn-sm btn-outline-danger">Reset Data</button>
            <button id="btnShowAll" class="btn btn-sm btn-outline-light">Tampilkan Semua</button>
          </div>
        </div>

        <div class="table-responsive" style="max-height:420px; overflow:auto;">
          <table class="table table-borderless table-hover align-middle mb-0" style="min-width:720px;">
            <thead>
              <tr>
                <th style="width:110px">Tanggal</th>
                <th>Deskripsi</th>
                <th style="width:160px">Kategori</th>
                <th style="width:120px" class="text-end">Pemasukan</th>
                <th style="width:120px" class="text-end">Pengeluaran</th>
                <th style="width:110px" class="text-end">Aksi</th>
              </tr>
            </thead>
            <tbody id="transactionsBody">
              <!-- rows -->
            </tbody>
          </table>
        </div>
      </div>

    </div> <!-- /grid -->
  </div> <!-- /container-main -->

  <!-- Floating Add Button -->
  <div class="fab-wrap" aria-hidden="false">
    <div class="fab-bg"></div>
    <button id="fabAdd" class="fab" title="Tambah transaksi"><i class="bi bi-plus-lg"></i></button>
  </div>

  <!-- hidden file input -->
  <input id="fileInput" type="file" accept=".csv" class="d-none">

  <!-- Modal Add/Edit -->
  <div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="formTransaction" class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="modalTitle">Tambah Transaksi</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="txId">
          <div class="mb-2">
            <label class="form-label">Tanggal</label>
            <input id="txDate" class="form-control" type="date" required>
          </div>

          <div class="mb-2">
            <label class="form-label">Deskripsi</label>
            <input id="txDesc" class="form-control" type="text" placeholder="Contoh: Gaji, Belanja..." required>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Tipe</label>
              <select id="txType" class="form-select">
                <option value="in">Pemasukan</option>
                <option value="out" selected>Pengeluaran</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Jumlah (Rp)</label>
              <input id="txAmount" class="form-control" type="number" step="0.01" min="0" placeholder="0" required>
            </div>
          </div>

          <div class="mb-2 mt-2">
            <label class="form-label">Kategori</label>
            <select id="txCategory" class="form-select"></select>
            <input id="txCategoryCustom" class="form-control mt-2 d-none" type="text" placeholder="Nama kategori (mis. Tips, Bonus...)">
          </div>

          <div class="form-text muted-sm">Pilih kategori dari daftar. Untuk kategori lain pilih "Lainnya" dan tulis nama kategori.</div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-sm btn-outline-light" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-sm btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ======= Konfigurasi & Util =======
    const STORAGE_KEY = 'cashflow_data_v1';
    const $ = (s, ctx=document) => ctx.querySelector(s);
    const $$ = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));

    function formatCurrency(value) {
      const v = Number(value) || 0;
      return v.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 });
    }
    function formatDateISO(date) {
      const d = new Date(date);
      if (isNaN(d)) return '';
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function formatDateDisplay(dateISO) {
      const d = new Date(dateISO);
      if (isNaN(d)) return '';
      return d.toLocaleDateString('id-ID');
    }
    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
    function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function showToast(message, cls='bg-dark text-white') {
      const container = document.querySelector('.toast-container');
      const toastEl = document.createElement('div');
      toastEl.className = 'toast align-items-center show ' + cls;
      toastEl.setAttribute('role','alert');
      toastEl.style.marginBottom = '8px';
      toastEl.innerHTML = `<div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
      </div>`;
      container.appendChild(toastEl);
      toastEl.querySelector('.btn-close').addEventListener('click', () => toastEl.remove());
      setTimeout(() => { toastEl.remove(); }, 4200);
    }

    // ====== Categories per requirement ======
    const incomeCategories = ['Gaji', 'Pendapatan lainnya', 'Lainnya'];
    const expenseCategories = ['Makan / Minuman','Nongkrong','Hiburan','Kesehatan','Service','Lainnya'];

    // ====== Data Model ======
    let transactions = [];
    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try { transactions = JSON.parse(raw) || []; }
        catch(e){ transactions = []; console.error('Parse error', e); }
      } else {
        transactions = [
          { id: uid(), date: formatDateISO(new Date()), description: 'Gaji contoh', category: 'Gaji', amount: 5000000, type: 'in' },
          { id: uid(), date: formatDateISO(new Date()), description: 'Belanja contoh', category: 'Makan / Minuman', amount: 350000, type: 'out' }
        ];
        saveData();
      }
    }
    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions)); }
    function resetData(){ if (!confirm('Reset semua data? Tindakan ini tidak dapat dibatalkan.')) return; transactions=[]; saveData(); renderAll(); showToast('Data direset', 'bg-danger text-white'); }

    // ====== Rendering ======
    const cardBalance = $('#cardBalance');
    const cardIncome = $('#cardIncome');
    const cardExpense = $('#cardExpense');
    const cardCount = $('#cardCount');
    const transactionsBody = $('#transactionsBody');
    const searchInput = $('#searchInput');
    const filterTime = $('#filterTime');
    const customRange = $('#customRange');
    const customFrom = $('#customFrom');
    const customTo = $('#customTo');
    const applyRange = $('#applyRange');

    function calcSummary(list) {
      let income = 0, expense = 0;
      for (const t of list) {
        if (t.type === 'in') income += Number(t.amount) || 0;
        else expense += Number(t.amount) || 0;
      }
      return { income, expense, balance: income - expense, count: list.length };
    }

    function renderSummary(filtered = transactions) {
      const s = calcSummary(filtered);
      cardIncome.textContent = formatCurrency(s.income);
      cardExpense.textContent = formatCurrency(s.expense);
      cardBalance.textContent = formatCurrency(s.balance);
      cardCount.textContent = s.count;
      $('#cardNetLabel').textContent = s.balance >= 0 ? 'Saldo bersih' : 'Saldo negatif';
    }

    function createCategoryBadge(category) {
      return `<span class="badge-cat" title="${escapeHtml(category)}">${escapeHtml(category)}</span>`;
    }

    function renderTransactions(filterOpts = {}) {
      const q = (filterOpts.q || '').toLowerCase().trim();
      const time = filterOpts.time || 'all';
      const from = filterOpts.from;
      const to = filterOpts.to;
      let list = [...transactions];

      if (q) {
        list = list.filter(t => (t.description||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q));
      }

      const now = new Date();
      if (time === 'today') {
        const today = formatDateISO(now);
        list = list.filter(t => t.date === today);
      } else if (time === 'month') {
        const y = now.getFullYear(), m = now.getMonth();
        list = list.filter(t => {
          const d = new Date(t.date);
          return d.getFullYear() === y && d.getMonth() === m;
        });
      } else if (time === 'year') {
        const y = now.getFullYear();
        list = list.filter(t => new Date(t.date).getFullYear() === y);
      } else if (time === 'custom' && from && to) {
        const fromT = new Date(from).setHours(0,0,0,0);
        const toT = new Date(to).setHours(23,59,59,999);
        list = list.filter(t => {
          const d = new Date(t.date).getTime();
          return d >= fromT && d <= toT;
        });
      }

      list.sort((a,b) => new Date(b.date) - new Date(a.date));

      transactionsBody.innerHTML = '';
      if (list.length === 0) {
        transactionsBody.innerHTML = '<tr><td colspan="6"><div class="text-muted" style="padding:18px 0; text-align:center">Belum ada transaksi sesuai filter</div></td></tr>';
      } else {
        for (const t of list) {
          const tr = document.createElement('tr');
          const inAmount = t.type === 'in' ? formatCurrency(Math.abs(Number(t.amount))) : '';
          const outAmount = t.type === 'out' ? formatCurrency(Math.abs(Number(t.amount))) : '';
          tr.innerHTML = `
            <td style="width:110px">${formatDateDisplay(t.date)}</td>
            <td>${escapeHtml(t.description)}</td>
            <td style="width:160px">${createCategoryBadge(t.category)}</td>
            <td class="text-end" style="width:120px">${inAmount}</td>
            <td class="text-end" style="width:120px">${outAmount}</td>
            <td class="text-end" style="width:110px">
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-light btn-edit" data-id="${t.id}" title="Edit"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger btn-delete" data-id="${t.id}" title="Hapus"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          `;
          transactionsBody.appendChild(tr);
        }
      }

      renderSummary(list);
      updateCharts();
    }

    function renderAll() {
      renderSummary(transactions);
      renderTransactions({ q: searchInput.value, time: filterTime.value, from: customFrom.value, to: customTo.value });
      updateCharts();
    }

    // ====== CRUD ======
    function addTransaction(tx) {
      tx.id = uid();
      transactions.push(tx);
      saveData();
      renderAll();
      showToast('Transaksi disimpan', 'bg-success text-white');
    }
    function updateTransaction(id, data) {
      const idx = transactions.findIndex(t => t.id === id);
      if (idx === -1) return;
      transactions[idx] = { ...transactions[idx], ...data };
      saveData();
      renderAll();
      showToast('Perubahan disimpan', 'bg-success text-white');
    }
    function deleteTransaction(id) {
      if (!confirm('Hapus transaksi ini?')) return;
      transactions = transactions.filter(t => t.id !== id);
      saveData();
      renderAll();
      showToast('Transaksi dihapus', 'bg-danger text-white');
    }

    // ====== Modal & Form Handling (with category presets) ======
    const modal = new bootstrap.Modal($('#modalForm'));
    const modalTitle = $('#modalTitle');
    const formTransaction = $('#formTransaction');

    // category select elements
    const txTypeEl = $('#txType');
    const txCategoryEl = $('#txCategory');
    const txCategoryCustom = $('#txCategoryCustom');

    function populateCategoryOptions(type) {
      let list = type === 'in' ? incomeCategories : expenseCategories;
      txCategoryEl.innerHTML = '';
      list.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        txCategoryEl.appendChild(opt);
      });
      txCategoryCustom.classList.add('d-none');
    }

    function openAddModal() {
      modalTitle.textContent = 'Tambah Transaksi';
      $('#txId').value = '';
      $('#txDate').value = formatDateISO(new Date());
      $('#txDesc').value = '';
      $('#txAmount').value = '';
      txTypeEl.value = 'out';
      populateCategoryOptions('out');
      txCategoryEl.value = expenseCategories[0] || 'Lainnya';
      txCategoryCustom.value = '';
      modal.show();
    }

    function openEditModal(id) {
      const tx = transactions.find(t => t.id === id);
      if (!tx) { showToast('Transaksi tidak ditemukan', 'bg-warning text-dark'); return; }
      modalTitle.textContent = 'Edit Transaksi';
      $('#txId').value = tx.id;
      $('#txDate').value = formatDateISO(tx.date);
      $('#txDesc').value = tx.description;
      $('#txAmount').value = tx.amount;
      txTypeEl.value = tx.type;
      populateCategoryOptions(tx.type);
      // if category not in preset, set to Lainnya and show custom
      const preset = tx.type === 'in' ? incomeCategories : expenseCategories;
      if (preset.includes(tx.category)) {
        txCategoryEl.value = tx.category;
        txCategoryCustom.value = '';
        txCategoryCustom.classList.add('d-none');
      } else {
        txCategoryEl.value = 'Lainnya';
        txCategoryCustom.classList.remove('d-none');
        txCategoryCustom.value = tx.category;
      }
      modal.show();
    }

    // when type change, update categories
    txTypeEl.addEventListener('change', () => {
      populateCategoryOptions(txTypeEl.value);
    });

    // when category change, show custom input when "Lainnya"
    txCategoryEl.addEventListener('change', () => {
      if (txCategoryEl.value === 'Lainnya') txCategoryCustom.classList.remove('d-none');
      else txCategoryCustom.classList.add('d-none');
    });

    formTransaction.addEventListener('submit', function(e) {
      e.preventDefault();
      const id = $('#txId').value;
      const categoryVal = txCategoryEl.value === 'Lainnya' ? (txCategoryCustom.value.trim() || 'Lainnya') : txCategoryEl.value;
      const data = {
        date: $('#txDate').value || formatDateISO(new Date()),
        description: $('#txDesc').value.trim() || '(Tanpa deskripsi)',
        category: categoryVal,
        amount: Math.abs(Number($('#txAmount').value) || 0),
        type: txTypeEl.value
      };
      if (!data.amount) { showToast('Masukkan jumlah yang valid', 'bg-warning text-dark'); return; }
      if (id) updateTransaction(id, data);
      else addTransaction(data);
      modal.hide();
    });

    // ====== Filters & Search ======
    filterTime.addEventListener('change', () => {
      if (filterTime.value === 'custom') customRange.classList.remove('d-none');
      else {
        customRange.classList.add('d-none');
        renderTransactions({ q: searchInput.value, time: filterTime.value, from: customFrom.value, to: customTo.value });
      }
    });
    applyRange.addEventListener('click', () => {
      if (!customFrom.value || !customTo.value) { showToast('Pilih tanggal dari dan ke', 'bg-warning text-dark'); return; }
      renderTransactions({ q: searchInput.value, time: 'custom', from: customFrom.value, to: customTo.value });
    });
    searchInput.addEventListener('input', debounce(() => {
      renderTransactions({ q: searchInput.value, time: filterTime.value, from: customFrom.value, to: customTo.value });
    }, 250));
    $('#btnShowAll').addEventListener('click', () => {
      searchInput.value = ''; filterTime.value = 'all'; customRange.classList.add('d-none');
      renderTransactions({ q:'', time:'all' });
    });
    $('#btnClearAll').addEventListener('click', resetData);

    // ====== Charts (unchanged logic, adapted to data) ======
    let lineChart = null, pieChart = null;
    const lineCtx = $('#lineChart');
    const pieCtx = $('#pieChart');

    function aggregateForLine(range='30') {
      let items = [...transactions];
      items.sort((a,b) => new Date(a.date) - new Date(b.date));
      if (range !== 'all') {
        const n = Number(range);
        const start = new Date(); start.setDate(start.getDate() - (n-1)); start.setHours(0,0,0,0);
        items = items.filter(t => new Date(t.date) >= start);
      }
      const map = {};
      for (const t of items) {
        const d = formatDateISO(t.date);
        map[d] = (map[d] || 0) + (t.type==='in' ? Number(t.amount) : -Number(t.amount));
      }
      let firstDate;
      if (range === 'all') firstDate = items.length ? formatDateISO(items[0].date) : formatDateISO(new Date());
      else { const n = Number(range); const s = new Date(); s.setDate(s.getDate() - (n-1)); firstDate = formatDateISO(s); }
      const endDate = formatDateISO(new Date());
      const cur = new Date(firstDate);
      const labels = []; const data = [];
      let cumulative = transactions.filter(t => new Date(t.date) < new Date(firstDate)).reduce((s,t) => s + (t.type==='in'?Number(t.amount):-Number(t.amount)), 0);
      while (formatDateISO(cur) <= endDate) {
        const key = formatDateISO(cur);
        cumulative += (map[key] || 0);
        labels.push(key);
        data.push(Math.round(cumulative));
        cur.setDate(cur.getDate() + 1);
      }
      return { labels, data };
    }

    function aggregateForPie() {
      const map = {};
      for (const t of transactions) {
        const cat = t.category || 'Lainnya';
        map[cat] = (map[cat] || 0) + Math.abs(Number(t.amount));
      }
      const labels = Object.keys(map);
      const data = labels.map(k => Math.round(map[k]));
      return { labels, data };
    }

    function generateColors(n) {
      const base = ['#5b9df9','#20c997','#ff6b6b','#fd7e14','#6f42c1','#0dcaf0','#ffc107','#e83e8c','#6610f2','#4b5563'];
      const out = []; for (let i=0;i<n;i++) out.push(base[i%base.length]); return out;
    }

    function updateCharts() {
      const range = $('#trendRange').value;
      const lineAgg = aggregateForLine(range);
      const lineLabels = lineAgg.labels.map(d => (new Date(d)).toLocaleDateString('id-ID'));
      const lineData = lineAgg.data;

      if (lineChart) {
        lineChart.data.labels = lineLabels;
        lineChart.data.datasets[0].data = lineData;
        lineChart.update();
      } else {
        lineChart = new Chart(lineCtx, {
          type:'line',
          data:{ labels:lineLabels, datasets:[{ label:'Saldo (Rp)', data:lineData, borderColor:'#5b9df9', backgroundColor:'rgba(91,157,249,0.12)', fill:true, tension:0.28, pointRadius:2 }] },
          options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{ label: ctx => formatCurrency(ctx.parsed.y) } } }, scales:{ y:{ ticks:{ callback: v=> formatCurrency(v) } }, x:{ ticks:{ autoSkip:true, maxTicksLimit:8 } } }, maintainAspectRatio:false, animation:{ duration:600 } }
        });
      }

      const pieAgg = aggregateForPie();
      const pieLabels = pieAgg.labels;
      const pieData = pieAgg.data;
      const bg = generateColors(pieLabels.length);
      if (pieChart) {
        pieChart.data.labels = pieLabels;
        pieChart.data.datasets[0].data = pieData;
        pieChart.data.datasets[0].backgroundColor = bg;
        pieChart.update();
      } else {
        pieChart = new Chart(pieCtx, {
          type:'doughnut',
          data:{ labels:pieLabels, datasets:[{ data:pieData, backgroundColor:bg, borderWidth:0 }] },
          options:{ plugins:{ tooltip:{ callbacks:{ label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)}` } }, legend:{ position:'bottom' } }, cutout:'60%', maintainAspectRatio:false, animation:{ duration:600 } }
        });
      }
    }

    $('#trendRange').addEventListener('change', updateCharts);
    $('#btnRefreshCharts').addEventListener('click', () => { updateCharts(); showToast('Charts diperbarui', 'bg-dark text-white'); });

    // ====== Import / Export CSV ======
    const fileInput = $('#fileInput');
    $('#btnImportCSV').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        const text = ev.target.result;
        try {
          const parsed = parseCSV(text);
          let imported = 0;
          for (const r of parsed) {
            if (!r.date || !r.amount) continue;
            const tx = {
              id: uid(),
              date: formatDateISO(r.date),
              description: r.description || '(Imported)',
              category: r.category || 'Lainnya',
              amount: Math.abs(Number(r.amount) || 0),
              type: (r.type === 'in' || r.type === 'out') ? r.type : (Number(r.amount) >= 0 ? 'in' : 'out')
            };
            transactions.push(tx);
            imported++;
          }
          if (imported > 0) { saveData(); renderAll(); showToast('Berhasil mengimpor ' + imported + ' transaksi', 'bg-success text-white'); }
          else showToast('Tidak ada data valid yang diimpor', 'bg-warning text-dark');
        } catch (err) { showToast('Gagal mengimpor CSV', 'bg-danger text-white'); console.error(err); }
      };
      reader.readAsText(f, 'utf-8');
      fileInput.value = '';
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if (lines.length === 0) return [];
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const rows = [];
      for (let i=1;i<lines.length;i++){
        const parts = splitCSVLine(lines[i]);
        if (parts.length === 0) continue;
        const obj = {};
        for (let j=0;j<headers.length;j++){
          obj[headers[j]] = parts[j] !== undefined ? parts[j].trim().replace(/^"|"$/g,'') : '';
        }
        rows.push(obj);
      }
      return rows;
    }
    function splitCSVLine(line) {
      const result = []; let cur = '', inQuote=false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"') {
          if (inQuote && line[i+1] === '"') { cur += '"'; i++; } else inQuote = !inQuote;
        } else if (ch === ',' && !inQuote) { result.push(cur); cur = ''; } else cur += ch;
      }
      result.push(cur);
      return result;
    }

    $('#btnExportCSV').addEventListener('click', () => {
      if (transactions.length === 0) { showToast('Tidak ada transaksi untuk diekspor', 'bg-warning text-dark'); return; }
      const header = ['date','description','category','amount','type'];
      const rows = transactions.map(t => [
        `"${t.date}"`,
        `"${(t.description||'').replace(/"/g,'""')}"`,
        `"${(t.category||'').replace(/"/g,'""')}"`,
        `${t.amount}`,
        `${t.type}`
      ].join(','));
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cashflow_export_' + formatDateISO(new Date()) + '.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV diekspor', 'bg-dark text-white');
    });

    // ====== Export PDF (screenshot) ======
    $('#btnExportPDF').addEventListener('click', async () => {
      const container = document.querySelector('.container-main');
      if (!container) { showToast('Area tidak ditemukan', 'bg-danger text-white'); return; }
      const opt = { scale: 2, useCORS: true, logging: false };
      try {
        const canv = await html2canvas(container, opt);
        const imgData = canv.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgProps = pdf.getImageProperties(imgData);
        const imgRatio = imgProps.width / imgProps.height;
        const pdfImgWidth = pageWidth - 20;
        const pdfImgHeight = pdfImgWidth / imgRatio;
        pdf.addImage(imgData, 'PNG', 10, 10, pdfImgWidth, Math.min(pdfImgHeight, pdf.internal.pageSize.getHeight()-20));
        pdf.save('cashflow_' + formatDateISO(new Date()) + '.pdf');
        showToast('PDF diunduh', 'bg-dark text-white');
      } catch (err) {
        showToast('Gagal membuat PDF', 'bg-danger text-white');
        console.error(err);
      }
    });

    // ====== Utilities ======
    function debounce(fn, wait = 200) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }

    // ====== Init & Events ======
    function init() {
      loadData();
      renderAll();

      // FAB open modal
      $('#fabAdd').addEventListener('click', openAddModal);
      // header add also opens modal on larger screens
      $('#btnAddHeader').addEventListener('click', openAddModal);

      // delegate edit/delete
      document.body.addEventListener('click', function(e) {
        const edit = e.target.closest('.btn-edit');
        const del = e.target.closest('.btn-delete');
        if (edit) openEditModal(edit.dataset.id);
        if (del) deleteTransaction(del.dataset.id);
      });

      // keyboard shortcut: Ctrl/Cmd+N
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') { e.preventDefault(); openAddModal(); }
      });

      // observe charts (only update when visible)
      const obs = new IntersectionObserver(entries => {
        entries.forEach(en => { if (en.isIntersecting) updateCharts(); });
      }, { threshold: 0.2 });
      const lc = document.getElementById('lineChartCard');
      const pc = document.getElementById('pieChartCard');
      if (lc) obs.observe(lc);
      if (pc) obs.observe(pc);
    }

    init();

    // before unload safety if modal open
    window.addEventListener('beforeunload', (e) => {
      if (document.querySelector('.modal.show')) { e.preventDefault(); e.returnValue = ''; }
    });
  </script>
</body>
</html>
