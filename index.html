<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cashflow — Clean White Text</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <!-- html2canvas & jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --accent:#5b9df9;
      --card-radius:14px;
      --panel-bg: rgba(255,255,255,0.02);
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:linear-gradient(180deg,#071025 0%,#000000 100%);
      color:#ffffff; /* all text white */
      -webkit-font-smoothing:antialiased;
      padding-bottom:96px;
    }
    .container-main{max-width:1100px;margin:18px auto;padding:14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#bfe1ff,#5b9df9);display:flex;align-items:center;justify-content:center;color:#042a5a}
    .brand h1{margin:0;font-size:1rem;color:#fff}
    .brand small{display:block;color:#fff;font-size:.78rem;margin-top:2px}

    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .card{background:linear-gradient(180deg,var(--panel-bg), rgba(255,255,255,0.01));border-radius:var(--card-radius);border:1px solid rgba(255,255,255,0.03);padding:12px;transition:transform .18s,box-shadow .18s}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(3,6,23,0.6)}
    .muted-sm{color:#ffffff !important;font-size:.85rem}
    .balance{font-weight:700;font-size:1.2rem;color:#ffffff}
    .icon-circle{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center}

    .card-1,.card-2,.card-3,.card-4{grid-column:span 3}
    @media (max-width:992px){.card-1,.card-2,.card-3,.card-4{grid-column:span 6}}
    @media (max-width:640px){.card-1,.card-2,.card-3,.card-4{grid-column:span 12}.container-main{padding:10px;margin:10px}}

    .charts{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:10px}
    @media (max-width:900px){.charts{grid-template-columns:1fr}}

    .transactions-card{grid-column:1/-1;margin-top:12px;padding:10px}
    .badge-cat{font-size:.78rem;padding:.25rem .45rem;border-radius:10px;background:transparent;color:#ffffff;border:1px solid rgba(255,255,255,0.04)}

    /* FAB */
    .fab-wrap{position:fixed;right:18px;bottom:18px;z-index:1100;display:flex;align-items:center;justify-content:center;gap:8px}
    .fab-bg{position:absolute;right:0;bottom:0;width:84px;height:84px;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(91,157,249,0.12),rgba(91,157,249,0.04));filter:blur(6px);z-index:-1}
    .fab{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#5b9df9,#2b7be8);box-shadow:0 12px 30px rgba(43,123,232,0.25);color:#fff;border:0;display:flex;align-items:center;justify-content:center;font-size:1.4rem}
    .fab:active{transform:translateY(1px) scale(.995)}

    /* Non-transparent modal (solid) */
    .modal-content{background:#081726;color:inherit;border-radius:12px;border:1px solid rgba(255,255,255,0.06)}
    .form-control,.form-select{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);color:#fff}

    .table-responsive{-webkit-overflow-scrolling:touch}
    table, th, td { color: #ffffff !important; } /* ensure table text white */

    /* page nav */
    .page-nav { display:flex; gap:8px; margin: 10px 0 18px; flex-wrap:wrap; }
    .page-nav .btn { min-width:120px; color: #fff; border-color: rgba(255,255,255,0.06); background: transparent; }
    .page-nav .btn:hover { color: #fff; }

    /* removed per-word backgrounds: keep text white only */
    .readable { background: transparent !important; padding: 0 !important; border-radius: 0 !important; color: #ffffff !important; }
    .balance.readable { padding: 0 !important; font-size:1.15rem; }
    .muted-sm.readable { padding: 0 !important; border-radius: 0 !important; color:#ffffff !important; }
    .stat-value.readable { padding: 0 !important; border-radius: 0 !important; display:inline-block; color:#ffffff !important; }

    /* transition classes for pages */
    .page { opacity: 0; transform: translateY(8px) scale(.998); transition: opacity .36s ease, transform .36s ease; will-change: opacity, transform; }
    .page.showing { opacity: 1; transform: translateY(0) scale(1); }
    .page.hiding { opacity: 0; transform: translateY(-8px) scale(.996); }

    .btn.active-page { background: linear-gradient(90deg,#0e2a48,#073049); color:#fff; border-radius:10px; }

    @media (max-width:640px){
      .page-nav .btn { min-width:110px; font-size:.92rem; padding:.45rem .6rem; }
    }
  </style>
</head>
<body>
  <div class="container-main">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><i class="bi bi-cash-stack"></i></div>
        <div>
          <h1 class="readable">CASHFLOW</h1>
          <small class="muted-sm readable">Kelola keuangan anda dengan benar dan aman</small>
        </div>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <button id="btnExportPDF" class="btn btn-outline-light btn-sm" title="Export PDF"><i class="bi bi-file-earmark-pdf"></i></button>
        <button id="btnExportCSV" class="btn btn-outline-light btn-sm" title="Export CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
        <button id="btnImportCSV" class="btn btn-outline-light btn-sm" title="Import CSV"><i class="bi bi-file-earmark-arrow-up"></i></button>
        <button id="btnAddHeader" class="btn btn-primary btn-sm ms-2 d-none d-md-inline" title="Tambah transaksi (besar)"><i class="bi bi-plus-lg"></i> Tambah</button>
      </div>
    </div>

    <!-- summary cards -->
    <div class="grid">
      <div class="card card-1">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="muted-sm readable">Saldo</div>
            <div id="cardBalance" class="balance readable">Rp 0</div>
            <div id="cardNetLabel" class="muted-sm readable">Total</div>
          </div>
          <div class="icon-circle" style="background:linear-gradient(135deg,#e6f0ff,#cfe9ff)"><i class="bi bi-wallet2" style="color:#052036"></i></div>
        </div>
      </div>

      <div class="card card-2">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="muted-sm readable">Pemasukan</div>
            <div id="cardIncome" class="balance text-success readable">Rp 0</div>
            <div class="muted-sm readable">Total pemasukan</div>
          </div>
          <div class="icon-circle" style="background:linear-gradient(135deg,#e9fbf0,#bff6da)"><i class="bi bi-cash-stack text-success"></i></div>
        </div>
      </div>

      <div class="card card-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="muted-sm readable">Pengeluaran</div>
            <div id="cardExpense" class="balance text-danger readable">Rp 0</div>
            <div class="muted-sm readable">Total pengeluaran</div>
          </div>
          <div class="icon-circle" style="background:linear-gradient(135deg,#fff0f0,#ffdede)"><i class="bi bi-credit-card-2-back text-danger"></i></div>
        </div>
      </div>

      <div class="card card-4">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="muted-sm readable">Transaksi</div>
            <div id="cardCount" class="balance readable">0</div>
            <div class="muted-sm readable">Total transaksi</div>
          </div>
          <div class="icon-circle" style="background:linear-gradient(135deg,#faf7ff,#e9deff)"><i class="bi bi-list-check"></i></div>
        </div>
      </div>

      <!-- mini charts & page nav -->
      <div class="card" style="grid-column: 1 / -1;">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h6 class="readable" style="margin:0">Ringkasan Grafik</h6>
            <small class="muted-sm readable">Pilih halaman untuk melihat detail</small>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <select id="trendRange" class="form-select form-select-sm" style="width:120px">
              <option value="7">7 Hari</option>
              <option value="30" selected>30 Hari</option>
              <option value="90">90 Hari</option>
              <option value="365">1 Tahun</option>
              <option value="all">Semua</option>
            </select>
            <button id="btnRefreshCharts" class="btn btn-outline-light btn-sm" title="Refresh"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px;align-items:stretch;flex-wrap:wrap;">
          <div class="card p-2" id="miniLineCard" style="flex:2; min-width:260px; min-height:180px;">
            <canvas id="miniLine" style="max-height:180px"></canvas>
          </div>
          <div class="card p-2" id="miniPieCard" style="flex:1; min-width:150px; min-height:180px;">
            <canvas id="miniPie" style="max-height:180px"></canvas>
          </div>
        </div>

        <div class="page-nav mt-3">
          <button class="btn btn-outline-light btn-sm page-btn active-page" data-page="history">Riwayat</button>
          <button class="btn btn-outline-light btn-sm page-btn" data-page="grafik">Grafik</button>
          <button class="btn btn-outline-light btn-sm page-btn" data-page="chart">Chart</button>
          <button class="btn btn-outline-light btn-sm page-btn" data-page="analisis">Analisis</button>
        </div>
      </div>

      <!-- PAGE: History -->
      <section id="page-history" class="card page" style="grid-column:1/-1;">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-3">
          <div class="d-flex gap-2 align-items-center" style="flex:1; min-width:200px;">
            <div class="input-group input-group-sm" style="max-width:360px;">
              <span class="input-group-text bg-transparent border-0 text-white"><i class="bi bi-search"></i></span>
              <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="Cari deskripsi atau kategori..." style="color:#fff;">
            </div>
            <select id="filterTime" class="form-select form-select-sm" style="width:150px; color:#fff;">
              <option value="all" selected>Semua</option>
              <option value="today">Hari ini</option>
              <option value="month">Bulan ini</option>
              <option value="year">Tahun ini</option>
              <option value="custom">Rentang...</option>
            </select>
            <div id="customRange" class="d-none d-flex gap-2 align-items-center">
              <input id="customFrom" type="date" class="form-control form-control-sm" style="color:#fff;">
              <input id="customTo" type="date" class="form-control form-control-sm" style="color:#fff;">
              <button id="applyRange" class="btn btn-sm btn-outline-light">Terapkan</button>
            </div>
          </div>

          <div class="d-flex gap-2">
            <button id="btnClearAll" class="btn btn-sm btn-outline-danger">Reset Data</button>
            <button id="btnShowAll" class="btn btn-sm btn-outline-light">Tampilkan Semua</button>
          </div>
        </div>

        <div class="table-responsive" style="max-height:420px; overflow:auto;">
          <table class="table table-borderless table-hover align-middle mb-0" style="min-width:720px;">
            <thead>
              <tr>
                <th style="width:110px">Tanggal</th>
                <th>Deskripsi</th>
                <th style="width:160px">Kategori</th>
                <th style="width:120px" class="text-end">Pemasukan</th>
                <th style="width:120px" class="text-end">Pengeluaran</th>
                <th style="width:110px" class="text-end">Aksi</th>
              </tr>
            </thead>
            <tbody id="transactionsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- PAGE: Grafik (line) -->
      <section id="page-grafik" class="card page d-none" style="grid-column:1/-1;">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div><h6 style="margin:0">Tren Saldo (Detail)</h6><small class="muted-sm">Line chart</small></div>
            <div><button id="refreshLine" class="btn btn-sm btn-outline-light">Refresh</button></div>
          </div>
          <div style="min-height:320px"><canvas id="lineChartLarge"></canvas></div>
        </div>
      </section>

      <!-- PAGE: Chart (pie + bar) -->
      <section id="page-chart" class="card page d-none" style="grid-column:1/-1;">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6>Komposisi Kategori</h6>
              <div style="min-height:260px"><canvas id="pieChart"></canvas></div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h6>Jumlah per Kategori (Bar)</h6>
              <div style="min-height:260px"><canvas id="barChart"></canvas></div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: Analisis -->
      <section id="page-analisis" class="card page d-none" style="grid-column:1/-1;">
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-4"><div class="stat-card"><small class="muted-sm">Rata-rata Pemasukan / bulan</small><div id="avgIncome" class="stat-value">Rp 0</div></div></div>
          <div class="col-12 col-md-4"><div class="stat-card"><small class="muted-sm">Rata-rata Pengeluaran / bulan</small><div id="avgExpense" class="stat-value">Rp 0</div></div></div>
          <div class="col-12 col-md-4"><div class="stat-card"><small class="muted-sm">Transaksi Terbesar</small><div id="largestTx" class="stat-value">—</div></div></div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6"><div class="card p-3"><h6>Top Kategori (Pengeluaran)</h6><ul id="topExpenseCats" class="list-unstyled mb-0"></ul></div></div>
          <div class="col-12 col-md-6"><div class="card p-3"><h6>Top Kategori (Pemasukan)</h6><ul id="topIncomeCats" class="list-unstyled mb-0"></ul></div></div>
        </div>
      </section>

    </div> <!-- /grid -->
  </div> <!-- /container-main -->

  <!-- FAB -->
  <div class="fab-wrap" aria-hidden="false">
    <div class="fab-bg"></div>
    <button id="fabAdd" class="fab" title="Tambah transaksi"><i class="bi bi-plus-lg"></i></button>
  </div>

  <!-- hidden file input -->
  <input id="fileInput" type="file" accept=".csv" class="d-none">

  <!-- Modal Add/Edit (solid background) -->
  <div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="formTransaction" class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="modalTitle">Tambah Transaksi</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="txId">
          <div class="mb-2">
            <label class="form-label">Tanggal</label>
            <input id="txDate" class="form-control" type="date" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Deskripsi</label>
            <input id="txDesc" class="form-control" type="text" placeholder="Contoh: Gaji, Belanja..." required>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Tipe</label>
              <select id="txType" class="form-select">
                <option value="in">Pemasukan</option>
                <option value="out" selected>Pengeluaran</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Jumlah (Rp)</label>
              <input id="txAmount" class="form-control" type="number" step="0.01" min="0" placeholder="0" required>
            </div>
          </div>
          <div class="mb-2 mt-2">
            <label class="form-label">Kategori</label>
            <select id="txCategory" class="form-select"></select>
            <input id="txCategoryCustom" class="form-control mt-2 d-none" type="text" placeholder="Nama kategori (mis. Tips, Bonus...)">
          </div>
          <div class="form-text muted-sm">Pilih kategori dari daftar. Untuk kategori lain pilih "Lainnya".</div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-sm btn-outline-light" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-sm btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Utilities
    const STORAGE_KEY = 'cashflow_data_v1';
    const $ = (s, ctx=document) => ctx.querySelector(s);
    const $$ = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));
    function formatCurrency(v){ const n=Number(v)||0; return n.toLocaleString('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}); }
    function formatDateISO(d){ const dt=new Date(d); if(isNaN(dt)) return ''; const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const day=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function formatDateDisplay(d){ const dt=new Date(d); if(isNaN(dt)) return ''; return dt.toLocaleDateString('id-ID'); }
    function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
    function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function showToast(msg, cls='bg-dark text-white'){ const c=document.querySelector('.toast-container'); const t=document.createElement('div'); t.className='toast align-items-center show '+cls; t.setAttribute('role','alert'); t.style.marginBottom='8px'; t.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button></div>`; c.appendChild(t); t.querySelector('.btn-close').addEventListener('click',()=>t.remove()); setTimeout(()=>t.remove(),4200); }

    // Categories
    const incomeCategories = ['Gaji','Pendapatan lainnya','Lainnya'];
    const expenseCategories = ['Makan / Minuman','Nongkrong','Hiburan','Kesehatan','Service','Lainnya'];

    // Data model
    let transactions = [];
    function loadData(){ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ try{ transactions = JSON.parse(raw) || []; } catch(e){ transactions = []; console.error(e); } } else { transactions = [{ id:uid(), date:formatDateISO(new Date()), description:'Gaji contoh', category:'Gaji', amount:5000000, type:'in' }, { id:uid(), date:formatDateISO(new Date()), description:'Belanja contoh', category:'Makan / Minuman', amount:350000, type:'out' }]; saveData(); } }
    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions)); }
    function resetData(){ if(!confirm('Reset semua data?')) return; transactions = []; saveData(); renderAll(); showToast('Data direset','bg-danger text-white'); }

    // Rendering
    const cardBalance = $('#cardBalance'), cardIncome = $('#cardIncome'), cardExpense = $('#cardExpense'), cardCount = $('#cardCount');
    const transactionsBody = $('#transactionsBody'), searchInput = $('#searchInput'), filterTime = $('#filterTime');
    const customRange = $('#customRange'), customFrom = $('#customFrom'), customTo = $('#customTo'), applyRange = $('#applyRange');

    function calcSummary(list){ let inc=0, exp=0; for(const t of list){ if(t.type==='in') inc+=Number(t.amount)||0; else exp+=Number(t.amount)||0; } return { income:inc, expense:exp, balance:inc-exp, count:list.length }; }

    function renderSummary(filtered = transactions){ const s = calcSummary(filtered); cardIncome.textContent = formatCurrency(s.income); cardExpense.textContent = formatCurrency(s.expense); cardBalance.textContent = formatCurrency(s.balance); cardCount.textContent = s.count; $('#cardNetLabel').textContent = s.balance >= 0 ? 'Saldo bersih' : 'Saldo negatif'; }

    function createCategoryBadge(category){ return `<span class="badge-cat">${escapeHtml(category)}</span>`; }

    function renderTransactions(filterOpts = {}) {
      const q = (filterOpts.q || '').toLowerCase().trim();
      const time = filterOpts.time || 'all';
      const from = filterOpts.from, to = filterOpts.to;
      let list = [...transactions];
      if (q) list = list.filter(t => (t.description||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q));
      const now = new Date();
      if(time === 'today'){ const today = formatDateISO(now); list = list.filter(t => t.date === today); }
      else if(time === 'month'){ const y = now.getFullYear(), m = now.getMonth(); list = list.filter(t => { const d = new Date(t.date); return d.getFullYear() === y && d.getMonth() === m; }); }
      else if(time === 'year'){ const y = now.getFullYear(); list = list.filter(t => new Date(t.date).getFullYear() === y); }
      else if(time === 'custom' && from && to){ const fromT = new Date(from).setHours(0,0,0,0); const toT = new Date(to).setHours(23,59,59,999); list = list.filter(t => { const d = new Date(t.date).getTime(); return d >= fromT && d <= toT; }); }
      list.sort((a,b)=> new Date(b.date) - new Date(a.date));
      transactionsBody.innerHTML = '';
      if(list.length === 0){ transactionsBody.innerHTML = '<tr><td colspan="6"><div class="text-muted" style="padding:18px 0; text-align:center">Belum ada transaksi sesuai filter</div></td></tr>'; }
      else {
        for(const t of list){
          const tr = document.createElement('tr');
          const inAmount = t.type === 'in' ? formatCurrency(Math.abs(Number(t.amount))) : '';
          const outAmount = t.type === 'out' ? formatCurrency(Math.abs(Number(t.amount))) : '';
          tr.innerHTML = `
            <td style="width:110px">${formatDateDisplay(t.date)}</td>
            <td>${escapeHtml(t.description)}</td>
            <td style="width:160px">${createCategoryBadge(t.category)}</td>
            <td class="text-end" style="width:120px">${inAmount}</td>
            <td class="text-end" style="width:120px">${outAmount}</td>
            <td class="text-end" style="width:110px">
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-light btn-edit" data-id="${t.id}" title="Edit"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger btn-delete" data-id="${t.id}" title="Hapus"><i class="bi bi-trash"></i></button>
              </div>
            </td>`;
          transactionsBody.appendChild(tr);
        }
      }
      renderSummary(list);
      updateMiniCharts();
    }

    function renderAll(){ renderSummary(transactions); renderTransactions({ q: searchInput.value, time: filterTime.value, from: customFrom.value, to: customTo.value }); updateCharts(); updateAnalysis(); }

    // CRUD
    function addTransaction(tx){ tx.id = uid(); transactions.push(tx); saveData(); renderAll(); showToast('Transaksi disimpan','bg-success text-white'); }
    function updateTransaction(id, data){ const idx = transactions.findIndex(t => t.id === id); if(idx === -1) return; transactions[idx] = { ...transactions[idx], ...data }; saveData(); renderAll(); showToast('Perubahan disimpan','bg-success text-white'); }
    function deleteTransaction(id){ if(!confirm('Hapus transaksi ini?')) return; transactions = transactions.filter(t => t.id !== id); saveData(); renderAll(); showToast('Transaksi dihapus','bg-danger text-white'); }

    // Modal & categories
    const modal = new bootstrap.Modal($('#modalForm'));
    const modalTitle = $('#modalTitle'), formTransaction = $('#formTransaction');
    const txTypeEl = $('#txType'), txCategoryEl = $('#txCategory'), txCategoryCustom = $('#txCategoryCustom');

    function populateCategoryOptions(type){
      const list = type === 'in' ? incomeCategories : expenseCategories;
      txCategoryEl.innerHTML = '';
      list.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; txCategoryEl.appendChild(o); });
      txCategoryCustom.classList.add('d-none');
    }

    function openAddModal(){
      modalTitle.textContent = 'Tambah Transaksi';
      $('#txId').value = ''; $('#txDate').value = formatDateISO(new Date()); $('#txDesc').value = ''; $('#txAmount').value = '';
      txTypeEl.value = 'out'; populateCategoryOptions('out'); txCategoryEl.value = expenseCategories[0] || 'Lainnya'; txCategoryCustom.value = '';
      modal.show();
    }

    function openEditModal(id){
      const tx = transactions.find(t => t.id === id);
      if(!tx){ showToast('Transaksi tidak ditemukan','bg-warning text-dark'); return; }
      modalTitle.textContent = 'Edit Transaksi';
      $('#txId').value = tx.id; $('#txDate').value = formatDateISO(tx.date); $('#txDesc').value = tx.description; $('#txAmount').value = tx.amount;
      txTypeEl.value = tx.type; populateCategoryOptions(tx.type);
      const preset = tx.type === 'in' ? incomeCategories : expenseCategories;
      if(preset.includes(tx.category)){ txCategoryEl.value = tx.category; txCategoryCustom.classList.add('d-none'); txCategoryCustom.value = ''; }
      else{ txCategoryEl.value = 'Lainnya'; txCategoryCustom.classList.remove('d-none'); txCategoryCustom.value = tx.category; }
      modal.show();
    }

    txTypeEl.addEventListener('change', () => populateCategoryOptions(txTypeEl.value));
    txCategoryEl.addEventListener('change', () => { if(txCategoryEl.value === 'Lainnya') txCategoryCustom.classList.remove('d-none'); else txCategoryCustom.classList.add('d-none'); });

    formTransaction.addEventListener('submit', function(e){
      e.preventDefault();
      const id = $('#txId').value;
      const categoryVal = txCategoryEl.value === 'Lainnya' ? (txCategoryCustom.value.trim() || 'Lainnya') : txCategoryEl.value;
      const data = {
        date: $('#txDate').value || formatDateISO(new Date()),
        description: $('#txDesc').value.trim() || '(Tanpa deskripsi)',
        category: categoryVal,
        amount: Math.abs(Number($('#txAmount').value) || 0),
        type: txTypeEl.value
      };
      if(!data.amount){ showToast('Masukkan jumlah yang valid','bg-warning text-dark'); return; }
      if(id) updateTransaction(id, data); else addTransaction(data);
      modal.hide();
    });

    // Filters & search
    filterTime.addEventListener('change', () => {
      if(filterTime.value === 'custom') customRange.classList.remove('d-none');
      else { customRange.classList.add('d-none'); renderTransactions({ q: searchInput.value, time: filterTime.value, from: customFrom.value, to: customTo.value }); }
    });
    applyRange.addEventListener('click', () => {
      if(!customFrom.value || !customTo.value){ showToast('Pilih tanggal dari dan ke','bg-warning text-dark'); return; }
      renderTransactions({ q: searchInput.value, time: 'custom', from: customFrom.value, to: customTo.value });
    });
    searchInput.addEventListener('input', debounce(() => renderTransactions({ q: searchInput.value, time: filterTime.value, from: customFrom.value, to: customTo.value }), 250));
    $('#btnShowAll').addEventListener('click', () => { searchInput.value=''; filterTime.value='all'; customRange.classList.add('d-none'); renderTransactions({ q:'', time:'all' }); });
    $('#btnClearAll').addEventListener('click', resetData);

    // Charts
    let lineChart = null, pieChart = null, barChart = null, miniLine = null, miniPie = null;
    const lineCtx = $('#lineChartLarge'), pieCtx = $('#pieChart'), barCtx = $('#barChart');
    const miniLineCtx = $('#miniLine'), miniPieCtx = $('#miniPie');

    function aggregateForLine(range='30'){
      let items = [...transactions]; items.sort((a,b)=> new Date(a.date) - new Date(b.date));
      if(range !== 'all'){ const n = Number(range); const start = new Date(); start.setDate(start.getDate() - (n-1)); start.setHours(0,0,0,0); items = items.filter(t => new Date(t.date) >= start); }
      const map = {}; for(const t of items){ const d = formatDateISO(t.date); map[d] = (map[d]||0) + (t.type==='in' ? Number(t.amount) : -Number(t.amount)); }
      let firstDate; if(range === 'all') firstDate = items.length ? formatDateISO(items[0].date) : formatDateISO(new Date()); else { const n = Number(range); const s = new Date(); s.setDate(s.getDate() - (n-1)); firstDate = formatDateISO(s); }
      const endDate = formatDateISO(new Date()); const cur = new Date(firstDate); const labels = [], data = [];
      let cumulative = transactions.filter(t => new Date(t.date) < new Date(firstDate)).reduce((s,t) => s + (t.type==='in'?Number(t.amount):-Number(t.amount)), 0);
      while(formatDateISO(cur) <= endDate){ const k = formatDateISO(cur); cumulative += (map[k]||0); labels.push(k); data.push(Math.round(cumulative)); cur.setDate(cur.getDate()+1); }
      return { labels, data };
    }

    function aggregateForCategories(){
      const map = {};
      for(const t of transactions){ const cat = t.category || 'Lainnya'; map[cat] = (map[cat]||0) + Math.abs(Number(t.amount)); }
      const labels = Object.keys(map); const data = labels.map(k => Math.round(map[k])); return { labels, data };
    }

    function generateColors(n){ const base = ['#5b9df9','#20c997','#ff6b6b','#fd7e14','#6f42c1','#0dcaf0','#ffc107','#e83e8c','#6610f2','#4b5563']; const out=[]; for(let i=0;i<n;i++) out.push(base[i%base.length]); return out; }

    function updateCharts(){
      const range = $('#trendRange').value;
      const lineAgg = aggregateForLine(range);
      const labels = lineAgg.labels.map(d => (new Date(d)).toLocaleDateString('id-ID'));
      const data = lineAgg.data;

      if(lineChart){ lineChart.data.labels = labels; lineChart.data.datasets[0].data = data; lineChart.update(); }
      else if(lineCtx){ lineChart = new Chart(lineCtx, { type:'line', data:{ labels, datasets:[{ label:'Saldo (Rp)', data, borderColor:'#5b9df9', backgroundColor:'rgba(91,157,249,0.12)', fill:true, tension:0.28 }] }, options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{ label: ctx => formatCurrency(ctx.parsed.y) } } }, scales:{ y:{ ticks:{ callback: v => formatCurrency(v) } }, x:{ ticks:{ autoSkip:true, maxTicksLimit:12 } } }, maintainAspectRatio:false } }); }

      const catAgg = aggregateForCategories();
      if(pieChart){ pieChart.data.labels = catAgg.labels; pieChart.data.datasets[0].data = catAgg.data; pieChart.update(); }
      else if(pieCtx){ pieChart = new Chart(pieCtx, { type:'doughnut', data:{ labels:catAgg.labels, datasets:[{ data:catAgg.data, backgroundColor: generateColors(catAgg.labels.length) }] }, options:{ plugins:{ tooltip:{callbacks:{ label:ctx=>`${ctx.label}: ${formatCurrency(ctx.parsed)}`}}}, cutout:'60%', maintainAspectRatio:false } }); }

      if(barChart){ barChart.data.labels = catAgg.labels; barChart.data.datasets[0].data = catAgg.data; barChart.update(); }
      else if(barCtx){ barChart = new Chart(barCtx, { type:'bar', data:{ labels:catAgg.labels, datasets:[{ label:'Jumlah (Rp)', data:catAgg.data, backgroundColor: generateColors(catAgg.labels.length) }] }, options:{ indexAxis:'y', responsive:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{ label: ctx => formatCurrency(ctx.parsed.y) } } }, maintainAspectRatio:false } }); }
    }

    function updateMiniCharts(){
      const range = $('#trendRange').value;
      const lineAgg = aggregateForLine(range);
      const labels = lineAgg.labels.map(d => (new Date(d)).toLocaleDateString('id-ID'));
      const data = lineAgg.data;
      if(miniLine){ miniLine.data.labels = labels; miniLine.data.datasets[0].data = data; miniLine.update(); }
      else if(miniLineCtx){ miniLine = new Chart(miniLineCtx, { type:'line', data:{ labels, datasets:[{ data, borderColor:'#5b9df9', backgroundColor:'rgba(91,157,249,0.08)', fill:true, tension:0.28, pointRadius:0 }] }, options:{ responsive:true, plugins:{ legend:{display:false}}, maintainAspectRatio:false, scales:{ y:{ display:false }, x:{ display:false } } } }); }

      const catAgg = aggregateForCategories();
      if(miniPie){ miniPie.data.labels = catAgg.labels; miniPie.data.datasets[0].data = catAgg.data; miniPie.update(); }
      else if(miniPieCtx){ miniPie = new Chart(miniPieCtx, { type:'doughnut', data:{ labels:catAgg.labels, datasets:[{ data:catAgg.data, backgroundColor: generateColors(catAgg.labels.length), borderWidth:0 }] }, options:{ plugins:{legend:{display:false}}, cutout:'70%', maintainAspectRatio:false } }); }
    }

    // Analysis
    function updateAnalysis(){
      if(transactions.length === 0){
        $('#avgIncome').textContent = 'Rp 0'; $('#avgExpense').textContent = 'Rp 0'; $('#largestTx').textContent = '—'; $('#topExpenseCats').innerHTML = '<li class="text-muted">-</li>'; $('#topIncomeCats').innerHTML = '<li class="text-muted">-</li>'; return;
      }
      const mapInc = {}, mapExp = {};
      for(const t of transactions){ const d = new Date(t.date); const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; if(t.type==='in') mapInc[key] = (mapInc[key]||0) + Number(t.amount); else mapExp[key] = (mapExp[key]||0) + Number(t.amount); }
      const avgInc = Object.values(mapInc).reduce((a,b)=>a+b,0) / Math.max(1, Object.keys(mapInc).length);
      const avgExp = Object.values(mapExp).reduce((a,b)=>a+b,0) / Math.max(1, Object.keys(mapExp).length);
      $('#avgIncome').textContent = formatCurrency(Math.round(avgInc));
      $('#avgExpense').textContent = formatCurrency(Math.round(avgExp));
      const largest = transactions.slice().sort((a,b)=> Math.abs(b.amount) - Math.abs(a.amount))[0];
      $('#largestTx').textContent = largest ? `${largest.description} — ${largest.type==='in' ? '+' : ''}${formatCurrency(largest.amount)}` : '—';
      const incCats = {}, expCats = {};
      for(const t of transactions){ if(t.type==='in') incCats[t.category] = (incCats[t.category]||0)+Number(t.amount); else expCats[t.category] = (expCats[t.category]||0)+Number(t.amount); }
      const topExp = Object.entries(expCats).sort((a,b)=>b[1]-a[1]).slice(0,5);
      const topInc = Object.entries(incCats).sort((a,b)=>b[1]-a[1]).slice(0,5);
      $('#topExpenseCats').innerHTML = topExp.map(([k,v])=>`<li style="padding:.28rem 0">${escapeHtml(k)} <span class="text-muted" style="float:right">${formatCurrency(v)}</span></li>`).join('') || '<li class="text-muted">-</li>';
      $('#topIncomeCats').innerHTML = topInc.map(([k,v])=>`<li style="padding:.28rem 0">${escapeHtml(k)} <span class="text-muted" style="float:right">${formatCurrency(v)}</span></li>`).join('') || '<li class="text-muted">-</li>';
    }

    // Import / Export / PDF
    const fileInput = $('#fileInput');
    $('#btnImportCSV').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    function handleFileSelect(e){
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader(); reader.onload = function(ev){
        const text = ev.target.result;
        try{
          const parsed = parseCSV(text);
          let imported = 0;
          for(const r of parsed){
            if(!r.date || !r.amount) continue;
            const tx = { id: uid(), date: formatDateISO(r.date), description: r.description||'(Imported)', category: r.category||'Lainnya', amount: Math.abs(Number(r.amount)||0), type: (r.type==='in'||r.type==='out')? r.type : (Number(r.amount) >= 0 ? 'in' : 'out') };
            transactions.push(tx); imported++;
          }
          if(imported > 0){ saveData(); renderAll(); showToast('Berhasil mengimpor ' + imported + ' transaksi', 'bg-success text-white'); } else showToast('Tidak ada data valid yang diimpor', 'bg-warning text-dark');
        } catch(err){ showToast('Gagal mengimpor CSV','bg-danger text-white'); console.error(err); }
      };
      reader.readAsText(f, 'utf-8'); fileInput.value = '';
    }
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if(lines.length === 0) return [];
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const rows = [];
      for(let i=1;i<lines.length;i++){
        const parts = splitCSVLine(lines[i]); if(parts.length === 0) continue;
        const obj = {};
        for(let j=0;j<headers.length;j++) obj[headers[j]] = parts[j] !== undefined ? parts[j].trim().replace(/^"|"$/g,'') : '';
        rows.push(obj);
      }
      return rows;
    }
    function splitCSVLine(line){
      const res=[]; let cur=''; let inQuote=false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){ if(inQuote && line[i+1] === '"'){ cur += '"'; i++; } else inQuote = !inQuote; }
        else if(ch === ',' && !inQuote){ res.push(cur); cur=''; } else cur += ch;
      }
      res.push(cur); return res;
    }

    $('#btnExportCSV').addEventListener('click', () => {
      if(transactions.length === 0){ showToast('Tidak ada transaksi untuk diekspor','bg-warning text-dark'); return; }
      const header = ['date','description','category','amount','type'];
      const rows = transactions.map(t => [`"${t.date}"`, `"${(t.description||'').replace(/"/g,'""')}"`, `"${(t.category||'').replace(/"/g,'""')}"`, `${t.amount}`, `${t.type}`].join(','));
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'cashflow_export_' + formatDateISO(new Date()) + '.csv'; a.click(); URL.revokeObjectURL(url); showToast('CSV diekspor','bg-dark text-white');
    });

    $('#btnExportPDF').addEventListener('click', async () => {
      const container = document.querySelector('.container-main'); if(!container){ showToast('Area tidak ditemukan','bg-danger text-white'); return; }
      try{
        const canv = await html2canvas(container, { scale: 2, useCORS: true, logging: false });
        const imgData = canv.toDataURL('image/png'); const pdf = new jspdf.jsPDF('p','mm','a4');
        const pw = pdf.internal.pageSize.getWidth(); const ph = pdf.internal.pageSize.getHeight(); const imgProps = pdf.getImageProperties(imgData); const ratio = imgProps.width/imgProps.height;
        const pdfW = pw - 20; const pdfH = pdfW / ratio; pdf.addImage(imgData, 'PNG', 10, 10, pdfW, Math.min(pdfH, ph - 20)); pdf.save('cashflow_' + formatDateISO(new Date()) + '.pdf'); showToast('PDF diunduh','bg-dark text-white');
      } catch(err){ showToast('Gagal membuat PDF','bg-danger text-white'); console.error(err); }
    });

    // Routing w/ transitions
    const pages = ['history','grafik','chart','analisis'];
    let currentPage = null;
    function showPage(page){
      if(page === currentPage) return;
      const prev = currentPage ? document.getElementById('page-' + currentPage) : null;
      const next = document.getElementById('page-' + page);
      $$('.page-btn').forEach(b => b.classList.remove('active-page'));
      const activeBtn = $(`.page-btn[data-page="${page}"]`);
      if(activeBtn) activeBtn.classList.add('active-page');
      if(prev){
        prev.classList.remove('showing'); prev.classList.add('hiding');
        const onPrevEnd = () => { prev.classList.remove('hiding'); prev.classList.add('d-none'); prev.removeEventListener('transitionend', onPrevEnd); };
        prev.addEventListener('transitionend', onPrevEnd);
      }
      if(next){
        next.classList.remove('d-none'); void next.offsetWidth; next.classList.add('showing');
        setTimeout(() => {
          if(page === 'grafik' && lineChart) lineChart.resize();
          if(page === 'chart'){ if(pieChart) pieChart.resize(); if(barChart) barChart.resize(); }
          if(page === 'analisis') updateAnalysis();
          if(page === 'history') renderTransactions({ q: searchInput.value, time: filterTime.value, from: customFrom.value, to: customTo.value });
        }, 260);
      }
      currentPage = page; history.replaceState(null, '', '#' + page);
    }
    $$('.page-btn').forEach(b => b.addEventListener('click', () => showPage(b.dataset.page)));

    // Init
    function init(){
      loadData(); populateCategoryOptions('out'); renderAll();
      const startHash = (location.hash || '').replace('#','') || 'history';
      showPage(pages.includes(startHash) ? startHash : 'history');
      $('#fabAdd').addEventListener('click', openAddModal);
      $('#btnAddHeader').addEventListener('click', openAddModal);
      document.body.addEventListener('click', function(e){ const edit = e.target.closest('.btn-edit'); const del = e.target.closest('.btn-delete'); if(edit) openEditModal(edit.dataset.id); if(del) deleteTransaction(del.dataset.id); });
      $('#btnRefreshCharts').addEventListener('click', () => { updateCharts(); updateMiniCharts(); showToast('Charts diperbarui','bg-dark text-white'); });
      $('#refreshLine').addEventListener('click', () => { updateCharts(); showToast('Grafik diperbarui','bg-dark text-white'); });
      $('#btnImportCSV').addEventListener('click', () => fileInput.click());
      document.addEventListener('keydown', (e) => { if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n'){ e.preventDefault(); openAddModal(); } });
      const obs = new IntersectionObserver(entries => { entries.forEach(en => { if(en.isIntersecting) { updateMiniCharts(); } }); }, { threshold: 0.2 });
      const miniLC = document.getElementById('miniLineCard'); if(miniLC) obs.observe(miniLC);
      const miniPC = document.getElementById('miniPieCard'); if(miniPC) obs.observe(miniPC);
    }
    init();

    // helpers
    function debounce(fn, wait = 200){ let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }
  </script>
</body>
</html>
